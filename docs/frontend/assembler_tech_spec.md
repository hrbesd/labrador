# 组装器技术文档

## 功能

组装器完成的是从xml文件生成对应网站内容的工具，将xml中的内容字段与网站的模板组合起来。

此外，组合器还需要完成文章列表的分页功能（不对文章做分页，具体分页内容下面章节介绍），可以根据不同的设备、分辨率的需求，生成不同的分页内容，同时保证分页的内容可访问。


## 模板系统（已废弃）

模板的功能是实现前台表现和后台数据的分离。在后台数据保持稳定的情况下，可以通过修改前端少量的代码，来完成整个网站的大量网页生成工作，使前后台解耦合。

要实现的基本功能包括：

- 变量替换：在xml中定义的元素的内容，可以根据模板中的标签进行替换。
- 循环结构：能够实现基本的循环结构来填充数据。
- 判断结构：提供简单的if/else判断，满足某种条件的时候，才显示某些动作。

## 站点地图的处理

系统除文章具体内容之外的部分（首页、栏目列表、文章列表）需要通过`sitemap`进行生成。

- 首页生成：解析sitemap中`<website />`节点的内容，生成首页文件。
	* 首页包含的内容是栏目名称和栏目链接。
	* 栏目名称可以从sitemap中获取。
	* 栏目链接地址根据下一节的栏目生成方式生成。
- 栏目生成：在分析首页的过程中，可以或得到所有栏目的列表（对应xml文件中`<website />`节点的直接`<nodeList />`子节点的内容）
	* 每个子节点对应生成一个文件，文件名为`当前栏目名称 + "/"` 组成的字符串的hash值。
	* 对于子栏目和文章列表在生成时做相同的处理。
- 目录结构：最终生成的网站包括一个文件和三个目录
	* 文件是首页文件（index.html），
	* 栏目列表（文件夹名称为c）
	* 文章列表（文件夹名称为l）
	* 所有文章内容（文件夹名称为a）

## 反向查询

反向查询主要应用于处理文章内的链接内容。

在文章内遇到连接，按如下方式处理：

- 如果为相对地址，就利用当前页面的URL和相对地址，组合生成绝对URL地址。
- 如果是绝对URL就直接使用。
- 获取文章的绝对URL之后，首先生成文章的hash，然后去文件系统中查找，如果找到，则认为连接存在.
- URL经过hash得到的文件不存在，首先比较域名，如果域名不一致，认为是外链，添加提示。
- 如果域名一致，就尝试去`sitemap`中利用url反向查询。
- 在alpha版本中，为了保持高效快捷的完成实现，可以在内存中构建DOM树结构


## 分页功能

由于assembler生成的页面内容针对不同的设备有不同的表现，因此需要为不同的设备生成不同的最终页面。但是这增加了代码量，减少了系统的可维护程度。为了增强系统的稳定性和易实现程度，对系统分页作如下定义：

- 首页栏目不分页 __A__
- 栏目列表不分页 __A__
- 子栏目列表不分页 __A__
- 文章列表先抓取前100篇文章的标题和地址，在一页中显示，超出的栏目提供原始页面链接；在移动端做同样的处理。 __A__
- 文章内容不分页，内容最多十页，全部下载，进行显示；在移动端做同样的处理。 __A__
- 采用ajax动态加载文章列表，每加载一部分给出语音提示 __AAA__

只需要考虑以上提到的问题，其他分页选项暂不考虑。



## 文件生成

- 文件生成使用单层结构，文件名称使用原始页面完整URL地址的hash值
- 最终的访问URL地址构成：```改造之后的网站URL + <页面hash>.html```