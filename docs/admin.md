**Do NOT update this file because it was generated by a script.**

Generated on Mon Jul  9 16:58:34 CST 2012


# Admin Console Spec

*草稿*

*不保证与实现功能同步*

## 目的

结合功能模块，实现Feature Spec中关于服务运营的部分要求。

## 功能与用法

### 创建网站

#### 子命令

`create`

#### 输入

- `ID` 必需参数，字符串，如`harbin`
- `Host` 必需参数，字符串， 如`www.harbin.gov.cn`

#### 行为

- 为新网站生成文档
- 根据输入参数更新网站配置文件
- 根据输入参数更新DNS记录
- 修改Web Server配置文件，为网站开启二级域名

#### 示例

```
lab create harbin www.harbin.gov.cn
```

### 显示统计信息

#### 子命令

`info`

#### 输入

- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 行为

针对当前网站，给出如下统计信息：

- 是否自动更新
- 文件大小
- 目录个数
- 文件个数
- 上次更新时间

#### 示例

在网站目录下：

```
lab info
```

### 暂停/恢复更新

#### 子命令

`pause` `resume`

#### 输入

- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 行为

- 暂停/恢复当前网站更新

#### 示例

```
lab pause harbin
```
在网站目录下：

```
lab resume
```

### 重置网站

#### 子命令

`reset`

#### 输入

- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 行为

- 重置网站的所有规则、缓存和网页
- 只保留配置信息

#### 示例

```
lab reset harbin
```

### 启动/停止全部网站更新

#### 子命令

`start` `stop`

#### 输入

不需要参数。

#### 行为

- 为**当前用户**的`cron`安装/删除调度器

#### 示例

```
lab stop
```

### 备份/恢复网站

#### 子命令

`backup` `restore`

#### 输入

- `ID` 网站目录之内可以省略，字符串，如`harbin`
- `Dir` 备份必需参数，路径，备份到此目录
- `Archive` 恢复必需参数，路径，从这个备份包恢复

#### 行为

- 将网站下的所有配置、规则和网页打包储存
- 将备份内容恢复到当前网站

#### 示例

```
lab backup <Dir>
```

```
lab restore harbin <Archive>
```

### 手动更新网站

#### 子命令

`update`

#### 输入

- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 行为

- 运行调度器，依次执行各个功能模块


#### 示例

```
lab update
```

### 查看日志

#### 子命令

`log`

#### 输入

- `--console` 查看控制台的日志
- `--scheduler` `--daemon` 查看自动更新的日志
- 网站 ID

#### 行为

- 查看某个系统模块或网站的日志
- 无参数时查看所有系统日志的最近20条日志
- 使用网站名做参数时查看网站所有模块的最近20条日志

#### 示例

```
lab log --console
```

```
lab log harbin
```

### 编辑网站配置

#### 子命令

```
config
```

#### 输入

- `--global` 编辑全局配置
- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 显示网站列表

#### 子命令

```
list
```

### （开发者）运行单独功能模块

#### 子命令

`run …` `run … for …`

#### 输入

- `module` 功能模块名称，如：`spider`
- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 行为

- 为当前网站单独运行指定的功能模块
- 在网站自动更新时运行单独功能模块可能有无法预知的结果

#### 示例

```
lab run spider for harbin
```

```
lab run reactor
```

## 技术实现

### 语言

主要用Shell脚本语言实现。

### 架构

- `lab.sh` 为命令入口，根据子命令执行对应的脚本
- 子命令在`./console/commands/`目录里单独实现
- 辅助功能在`./console/utils/`里实现
- 在路径中建立为`lab.sh`建立Symbol Link，主命令简化用`lab`执行

## 已知问题

- 部分功能没有实现

# Labrador Scheduler Spec

## 被调度的模块顺序

* Spider
* Parser
* Reactor
* Assembler

## 参数和环境变量

* 脚本或程序被`CRON`调用，可能没有Login Shell中的环境变量
* 脚本被以绝对路径直接调用，需要自己指定解释器
* 脚本和程序被调用时都是symbol links

### 参数

* `--site-config=<dir/file>` 当前网站的配置文件
* `--source-dir=<dir>` 作为输入的目录
* `--worker-dir=<dir>` 本模块的工作目录
* `--shared-dir=<dir>` 模块间共享目录，最后一个需要文件的模块负责删除文件
* `--webroot-dir=<dir>` 当前网站的Web Server的根目录
* `--config-dir=<dir>` 配置文件目录；各自模块指定自己的配置文件；开发者编辑
* `--rule-dir=<dir>` 规则目录；各自模块指定自己的规则文件；运营方可编辑
* `--log-file=<dir/file>` 本模块的日志文件

#### 注意
* 以上目录和文件保证存在，私有配置和规则文件模块自己负责检查。
* 空目录中可能有placeholder。

#### 参数中不包括

- 脚本或程序实际文件所在位置（可以添加Working Directory参数）

## 日志

每个模块每次被调用前调度器自己会留下日志。

## 异常

* 不管时间频率如何，全局只有一个调度程序可以运行
* 整个流程如果没有成功完成，下次不会自动运行
* 可以手动清楚相应的Flag（程序内定义）

## 已知问题

* 无法指定网站被更新的顺序
* 固定每日自动更新（可以手动更新）
* 配置文件中的时间段暂时被忽略


# Monitor

***作废***

***因沟通误会而创建***

# Labrador Scheduler Spec

## 被调度的模块顺序

* Spider
* Parser
* Reactor
* Assembler

## 参数和环境变量

* 脚本或程序被`CRON`调用，可能没有Login Shell中的环境变量
* 脚本被以绝对路径直接调用，需要自己指定解释器
* 脚本和程序被调用时都是symbol links

### 参数

* `--site-config=<dir/file>` 当前网站的配置文件
* `--source-dir=<dir>` 作为输入的目录
* `--worker-dir=<dir>` 本模块的工作目录
* `--shared-dir=<dir>` 模块间共享目录，最后一个需要文件的模块负责删除文件
* `--webroot-dir=<dir>` 当前网站的Web Server的根目录
* `--config-dir=<dir>` 配置文件目录；各自模块指定自己的配置文件；开发者编辑
* `--rule-dir=<dir>` 规则目录；各自模块指定自己的规则文件；运营方可编辑
* `--log-file=<dir/file>` 本模块的日志文件

#### 注意
* 以上目录和文件保证存在，私有配置和规则文件模块自己负责检查。
* 空目录中可能有placeholder。

#### 参数中不包括

- 脚本或程序实际文件所在位置（可以添加Working Directory参数）

## 日志

每个模块每次被调用前调度器自己会留下日志。

## 异常

* 不管时间频率如何，全局只有一个调度程序可以运行
* 整个流程如果没有成功完成，下次不会自动运行
* 可以手动清楚相应的Flag（程序内定义）

## 已知问题

* 无法指定网站被更新的顺序
* 固定每日自动更新（可以手动更新）
* 配置文件中的时间段暂时被忽略


# 版本发布

## 三个更新通道

- Stable
- Unstable
- Dev

## 用法

### 修改配置文件

- `*.conf`
- `*.dirs`
- `*.butts`
- `*.links`


### 运行脚本


## 版本服务器的目录布局

### 约定

- 用户名是 `updater`
- 产品根目录是 `~/labrador`

## 如何实现

先在本地建立好目录结构，然后把要复制的 `butts` 文件用符号链接，使用 `rsync` 把符号链接当作文件复制。然后在 `bin` 目录里给 `butts` 里的文件建立符号链接，把符号链接按照符号链接复制。

# Labrador 服务器部署攻略

*草稿*

*不完整*

*尚未与代码同步*

## 操作系统

服务器统一采用 Ubuntu 11.10 系统。

### 初始化

#### 基本软件包

`apt-get install …`

- openssh-server
- apache2
- vim

#### 端口开通/映射

`80`
`22`

可能为 SSH 服务额外开通 `2222` `22222`

## 应用服务器类型

### Development Server

*“开发服务器”*

- 此类型服务器可以有多个

- 用户
	* GoF **(约定用户名)**

- 主要用途
	* 开发方同步 `~/repo`
	* 向 Update Server 发送更新
	
- 如何建立
	* 开发方手工建立
	
- 使用者
	* 开发方

- 权限
	* 用 `labrador` key 登录
	* 禁止密码登录
	* `sudo-er`
	
- 可以做什么？
	* 同步 Github repo
	* daily-build
	* 特殊情况下在线开发
	
- 不可以做什么?
	* 运行测试
	
### Update Server

*“更新服务器”*

- 此类型服务器只能有一个实例

- 用户
	* updater **(约定用户名)**
	
- 主要用途
	* 通过此服务器初始化 Test Server 和 Production Server
	* 测试主管发布更新

- 如何建立
	* 开发方通过[脚本](./admin/setup/updater/README.md)建立
	
- 使用者
	* Test Server 和 Production Server 的脚本
	* 除了测试主管，无需人登录

- 权限
	* 用 `labrador` 或 `esd` key 登录
	* 可以密码登录
	* 非 `sudo-er`
	
- 可以做什么？
	* 首次安装
	* 更新
	
- 不可以做什么?
	* 运行测试
	* Clone repo

### Test Server

*测试服务器*

- 此类型服务器可以有多个实例

- 用户
	* labrador **(约定用户名)**

- 主要用途
	* 测试软件
	* 模拟运营

- 如何建立
	* 系统管理员通过[安装脚本](./admin/setup/tester/README.md)建立（参考相关文档）
	* 从 Update Server 获得 ssh key-pair
	
- 使用者
	* 开发方或运营方的测试者

- 权限
	* 用 `labrador` key 登录
	* 禁止密码登录
	* 非 `sudo-er`
	
- 可以做什么？
	* 首次安装
	* 日常更新
	* 模拟运营
	
- 不可以做什么?
	* 扩大日常用户的权限

### Production Server

*运营服务器*

- 此类型服务器可以有多个实例

- 用户
	* labrador **(约定用户名)**

- 主要用途
	* 日常运营

- 如何建立
	* 系统管理员通过安装脚本建立（参考相关文档）
	* 从 Update Server 获得 ssh key-pair
	
- 使用者
	* 运营方日常操作人员

- 权限
	* 用 `labrador` key 登录
	* 禁止密码登录
	* 非 `sudo-er`
	
- 可以做什么？
	* 首次安装
	* 日常更新与运营
	
- 不可以做什么?
	* 扩大日常用户的权限

**注意** 此类型服务器默认从 `Stable` 通道获取更新.

### 备注

#### 以下服务器可以共用一个操作系统

- Development Server 
- Update Server
- Test Server

## 参考

- [Console 文档](./admin/console/README.md)
- [Updater Setup 文档](./admin/setup/updater/README.md)
- [Tester Setup 文档](./admin/setup/tester/README.md)

# 安装、配置、更新 Labrador

*草稿*

*不完整*

## Usage (临时文档)

```
Usage

	`basename $0` [options]
	
Options

	--check-env		Check environment for essential modules
	
	User labrador only:

	--make-dirs		Create required directories
	--sync-bin		Sync executable programs
	--sync-etc		Sync settings
	--modify-env	Modify environment variables
	
	Root only:

	--config-sshd	Modify the config file of sshd
	--create-user	Create the labrador user
	--install-keys	Install ssh keys, user labrador must exist
	
Note

	Check the first few lines of this script for basic settings.

```

## 约定

user name labrador
uid 1111

