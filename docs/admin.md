**Do NOT update this file because it was generated by a script.**


# Admin Console Spec

*草稿*

*不保证与实现功能同步*

## 目的

结合功能模块，实现Feature Spec中关于服务运营的部分要求。

## 功能与用法

### 创建网站

#### 子命令

`create`

#### 输入

- `ID` 必需参数，字符串，如`harbin`
- `Host` 必需参数，字符串， 如`www.harbin.gov.cn`

#### 行为

- 为新网站生成文档
- 根据输入参数更新网站配置文件
- 根据输入参数更新DNS记录
- 修改Web Server配置文件，为网站开启二级域名

#### 示例

```
lab create harbin www.harbin.gov.cn
```

### 显示统计信息

#### 子命令

`info`

#### 输入

- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 行为

针对当前网站，给出如下统计信息：

- 是否自动更新
- 文件大小
- 目录个数
- 文件个数
- 上次更新时间

#### 示例

在网站目录下：

```
lab info
```

### 暂停/恢复更新

#### 子命令

`pause` `resume`

#### 输入

- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 行为

- 暂停/恢复当前网站更新

#### 示例

```
lab pause harbin
```
在网站目录下：

```
lab resume
```

### 重置网站

#### 子命令

`reset`

#### 输入

- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 行为

- 重置网站的所有规则、缓存和网页
- 只保留配置信息

#### 示例

```
lab reset harbin
```

### 启动/停止全部网站更新

#### 子命令

`start` `stop`

#### 输入

不需要参数。

#### 行为

- 为**当前用户**的`cron`安装/删除调度器

#### 示例

```
lab stop
```

### 备份/恢复网站

#### 子命令

`backup` `restore`

#### 输入

- `ID` 网站目录之内可以省略，字符串，如`harbin`
- `Dir` 备份必需参数，路径，备份到此目录
- `Archive` 恢复必需参数，路径，从这个备份包恢复

#### 行为

- 将网站下的所有配置、规则和网页打包储存
- 将备份内容恢复到当前网站

#### 示例

```
lab backup
```

```
lab restore harbin
```

### 手动更新网站

#### 子命令

`update`

#### 输入

- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 行为

- 运行调度器，依次执行各个功能模块


#### 示例

```
lab update
```

### （开发者）运行单独功能模块

#### 子命令

`run …` `run … for …`

#### 输入

- `module` 功能模块名称，如：`spider`
- `ID` 网站目录之内可以省略，字符串，如`harbin`

#### 行为

- 为当前网站单独运行指定的功能模块
- 在网站自动更新时运行单独功能模块可能有无法预知的结果

#### 示例

```
lab run spider for harbin
```

```
lab run reactor
```

## 技术实现

### 语言

主要用Shell脚本语言实现。

### 架构

- `lab.sh` 为命令入口，根据子命令执行对应的脚本
- 子命令在`./console/commands/`目录里单独实现
- 辅助功能在`./console/utils/`里实现
- 在路径中建立为`lab.sh`建立Symbol Link，主命令简化用`lab`执行

## 已知问题

- 部分功能没有实现

# Monitor

***作废***

***因沟通误会而创建***

# Labrador Scheduler Spec

## 被调度的模块顺序

* Spider
* Parser
* Reactor
* Assembler

## 参数和环境变量

* 脚本或程序被`CRON`调用，可能没有Login Shell中的环境变量
* 脚本被以绝对路径直接调用，需要自己指定解释器
* 脚本和程序被调用时都是symbol links

### 参数

* `--site-config=<dir/file>` 当前网站的配置文件
* `--source-dir=<dir>` 作为输入的目录
* `--worker-dir=<dir>` 本模块的工作目录
* `--shared-dir=<dir>` 模块间共享目录，最后一个需要文件的模块负责删除文件
* `--webroot-dir=<dir>` 当前网站的Web Server的根目录
* `--config-dir=<dir>` 配置文件目录；各自模块指定自己的配置文件；开发者编辑
* `--rule-dir=<dir>` 规则目录；各自模块指定自己的规则文件；运营方可编辑
* `--log-file=<dir/file>` 本模块的日志文件

#### 注意
* 以上目录和文件保证存在，私有配置和规则文件模块自己负责检查。
* 空目录中可能有placeholder。

#### 参数中不包括

- 脚本或程序实际文件所在位置（可以添加Working Directory参数）

## 日志

每个模块每次被调用前调度器自己会留下日志。

## 异常

* 不管时间频率如何，全局只有一个调度程序可以运行
* 整个流程如果没有成功完成，下次不会自动运行
* 可以手动清楚相应的Flag（程序内定义）

## 已知问题

* 无法指定网站被更新的顺序
* 固定每日自动更新（可以手动更新）
* 配置文件中的时间段暂时被忽略


# Labrador 服务器部署攻略

*草稿*

*不完整*

## 操作系统

Development Server 和 Production Server 统一采用 Ubuntu 11.10 系统。

## Development Server

### 初始化

#### 基本软件包

`apt-get install …`

- openssh-server
- apache2
- vim

#### 端口开通/映射

`80`
`22`

### 用户

#### GoF

- 主要用途
	* 开发方同步 `~/repo`

- 如何建立
	* 手工建立
	
- 使用者
	* 开发方

- 权限
	* 用 `labrador` key 登录
	* 禁止密码登录
	* `sudo-er`
	
- 可以做什么？
	* 同步 Github repo
	* daily-build
	* 可以更新repo，但不推荐
	
- 不可以做什么?
	* 运行测试

#### updater
	
- 主要用途
	* setup
	* sync

- 如何建立
	* 手工建立
	
- 使用者
	* 开发方
	* 运行方

- 权限
	* 用 `labrador` 或 `esd` key 登录
	* 可以密码登录
	* 非 `sudo-er`
	
- 可以做什么？
	* 首次安装
	* 更新
	
- 不可以做什么?
	* 运行测试
	* Clone repo

#### labrador

- 主要用途
	* 模拟运营

- 如何建立
	* 安装脚本建立
	
- 使用者
	* 开发方

- 权限
	* 用 `labrador` key 登录
	* 禁止密码登录
	* 非 `sudo-er`
	
- 可以做什么？
	* 首次安装
	* 日常更新
	* 模拟运营
	
- 不可以做什么?
	* 扩大权限

**Note:** 尽量与 Production Server 的程序和配置一致
	
## Production Server

### 初始化

#### 基本软件包

`apt-get install …`

- openssh-server
- apache2
- vim

#### 端口开通/映射

`80`
`22`
`2222`
`22222`

#### 安装配置 Labrador

* 通过开发方提供的指示，运行安装脚本。
* 当前操作用户有时需要是 `root` 或者有 `sudo` 权限

满足以上条件，安装脚本会自动把新的服务器初始化成 Production Server.

对于已经运营的 Production Server，参考 [Setup 文档](./admin/setup/README.md) 。

#### 用户

- 安装系统的 `admin` 用户
	* 任何用户名都可以
	* `sudo-er`

- `labrador` 运营方日常工作用户
	* 此用户通过安装脚本自动建立和初始化
	* 禁止 `sudo`
	* 从 `updater` 用户复制 ssh key-pair

## 参考

- [Console 文档](./admin/console/README.md)
- [Setup 文档](./admin/setup/README.md)

# 安装、配置、更新 Labrador

*草稿*

*不完整*

## Usage (临时文档)

```
Usage

	`basename $0` [options]
	
Options

	--check-env		Check environment for essential modules
	
	User labrador only:

	--make-dirs		Create required directories
	--sync-bin		Sync executable programs
	--sync-etc		Sync settings
	--modify-env	Modify environment variables
	
	Root only:

	--config-sshd	Modify the config file of sshd
	--create-user	Create the labrador user
	--install-keys	Install ssh keys, user labrador must exist
	
Note

	Check the first few lines of this script for basic settings.

```

## 约定

user name labrador
uid 1111

