# Text-to-speech Web Service

*草稿*

*不完整*

## 目的
在云中建立一个SaaS，输入一段文字，转换成现代浏览器支持的格式的音频，输出URL，供其他服务调用。

## 功能

- 输入
	* 纯文本 __A__    完成
	* SSML __AA__
	
- 输出
	* MP3 __A__	完成
	* OGG __A__	完成
	* AAC __AA__
	* WAV __AA__
	* SWF __AAA__
	
- 查询状态
	* 返回任务状态 __A__ 完成
	
- 语言
	* 中文 __A__ 完成
	* 中英文混合 __AA__ 完成

## 实现
	
### 接口定义

*注意： 未设计验证机制*

#### 协议

* SOAP __A__	完成
* REST __AA__

#### 方法

* Text2Speech() __A__	完成
* Ssml2Speech() __A__	完成
* GetStatus() __A__	完成
* SetStatus()__A__	完成

#### 参数

- Text2Speech和Ssml2Speech
	* key (默认值 zhangjianzong)
	* Plain text
	* Base64 encoded text __AA__ 完成

- GetStatus
	* JobID

- SetStatus
	* ServerAddress 工作服务器的地址
	* JobID
	* Status 状态
#### 返回

- Text2Speech和Ssml2Speech
	* JobID（相关语音列表可以调用GetStatus获得详细信息）

- GetStatus	
	* 若干状态，分别表示（排队中，已合成，已转换，已上传，已知错误，未知错误）
	* 根据格式、男声女声、速度的不同返回URL集合。文档结构可见备注。

- SetStatus
	*根据状态返回下一个要处理的服务器网址。
### 负载管理

负载平衡管理以下三种类型的工作，通过监控队列，调整各类服务器实例的数量，保证平均流程完成时间低于N秒（N为人为配置的参数）。

*注意：以下三种类型的服务可能在同一个服务器内，也可能通过局域网或互联网连接*

### TTS Server

* 使用操作系统或其他商用TTS引擎搭建服务
* 如果产生临时文件，以文本的MD5 Hash结果命名
* 生成文件符合以下规范：

	- 采样：22KHz
	- 声道：单声道
	- 格式：见前面功能定义
	- 男声和女声（可以分别读标题和正文，根据用户配置）__AAA__
	- 分为慢、标准、快三个版本 __AA__

* 多线程，充分利用服务器资源
* 如果有需要，使用FTP等高效率的协议向下一阶段传送音频文件

### Transcoding Server 

* 以ffmpeg为平台搭建服务
* 如果产生临时文件，以文本的MD5 Hash结果命名
* 如果有需要，使用FTP等高效率的协议向下一阶段传送音频文件

### Web Server

Web Server提供静态音频文件的下载。文件以文本的MD5 Hash结果命名，也可用Hash的某种变形命名，以防止滥用。

*音频文件的目录结构有待定义。*

考虑到高负载和低延迟的要求，可能需要混合以下技术：

* 物理服务器
* AWS S3
* AWS EC2
* CDN

配置Web Server时，应鼓励用户代理使用**长期缓存**。

## 如何使用此服务

### 输入端

每次调用建议输入一句话，100字以下。
*参见前端已完成代码*

### 调用端

*参见前端已完成代码*

## 备注

<?xml version="1.0" encoding="UTF-8"?>
<ns2:getStatusResponse xmlns:ns2="http://esd.com/">
	<result>
		<audioList>
			<audio>
				<format>audio/mpeg</format>
				<speed>Normal</speed>
				<url>http://192.168.170.154:8080/WEB/voice/4cf551b7-ff08-4435-86f4-16d982e57b0e.mp3
				</url>
				<voice>
					<lang>chinese</lang>
					<sex>Female</sex>
				</voice>
			</audio>
			<audio>
				<format>audio/ogg</format>
				<speed>Normal</speed>
				<url>http://192.168.170.154:8080/WEB/voice/20c8abba-bf0f-47f2-9047-24527cefb0d0.ogg
				</url>
				<voice>
					<lang>chinese</lang>
					<sex>Female</sex>
				</voice>
			</audio>
		</audioList>
		<status>UPLOADED</status>
	</result>
</ns2:getStatusResponse>